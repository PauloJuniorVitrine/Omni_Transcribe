name: Validação do Sistema

permissions:
  contents: read
  actions: read

concurrency:
  group: system-validation-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test' }}
  CREDENTIALS_SECRET_KEY: ${{ secrets.CREDENTIALS_SECRET_KEY || 'test-credentials-key-32-bytes__' }}
  RUNTIME_CREDENTIALS_KEY: ${{ secrets.RUNTIME_CREDENTIALS_KEY || '' }}
  PLAYWRIGHT_BROWSERS_PATH: 0
  TEST_MODE: "1"
  SKIP_RUNTIME_CREDENTIALS_VERIFY: "1"
  VERSION: ${{ github.ref_name || format('ci-{0}', github.run_number) }}
  ALLOW_FAKE_SECRETS: ${{ github.event.pull_request && github.event.pull_request.head.repo.fork && '1' || '0' }}
  RUN_SMOKE_REAL: "0"

jobs:
  validate_secrets:
    name: Validar segredos necessários
    runs-on: ubuntu-latest
    # Evita falha em PRs de forks, onde segredos não estão disponíveis.
    if: ${{ !github.event.pull_request || github.event.pull_request.head.repo.fork == false }}
    steps:
      - name: Verificar se os segredos críticos estão presentes
        shell: bash
        run: |
          if [[ "${ALLOW_FAKE_SECRETS}" == "1" ]]; then
            echo "ALLOW_FAKE_SECRETS=1 definido; ignorando a validação de segredos."
            exit 0
          fi
          if [[ -z "${OPENAI_API_KEY}" || "${OPENAI_API_KEY}" == "sk-test" ]]; then
            echo "A chave OPENAI_API_KEY está ausente ou usando um marcador."
            exit 1
          fi
          if [[ -z "${CREDENTIALS_SECRET_KEY}" || "${CREDENTIALS_SECRET_KEY}" == "test-credentials-key-32-bytes__" ]]; then
            echo "CREDENTIALS_SECRET_KEY está ausente ou usando um marcador de posição."
            exit 1
          fi
          echo "Segredos parecem configurados."

  sast_and_secretscan:
    name: Análise estática e varredura secreta
    runs-on: ubuntu-latest
    needs: validate_secrets
    steps:
      - uses: actions/checkout@v4

      - name: Segurança em Python (bandit)
        uses: bandit-tool/bandit-action@v1
        with:
          bandit_args: "-r src -ll"

      - name: Varredura secreta (trivy fs)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"
          scanners: "secret"
          exit-code: "1"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - run: npm ci
      - run: npx eslint src/interfaces/web/static/js --max-warnings=0

  unit_tests:
    name: Testes unitários (Python + JS)
    runs-on: ubuntu-latest
    needs: sast_and_secretscan
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências do Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Executar pytest unitário
        run: |
          mkdir -p artifacts/unit/htmlcov
          pytest tests/unit \
            --cov=src \
            --cov-report=xml:artifacts/unit/coverage.xml \
            --cov-report=html:artifacts/unit/htmlcov \
            --cov-report=term-missing \
            --junitxml=artifacts/unit/pytest-unit.xml | tee artifacts/unit/output.log

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Instalar dependências JS
        run: npm ci

      - name: Lint JS
        run: npm run lint:js | tee artifacts/unit/js-lint.log

      - name: Executar testes JS
        run: npm run test:js | tee artifacts/unit/js-tests.log

      - name: Gerar cliente OpenAPI TS
        run: npm run generate:openapi:ts | tee artifacts/unit/openapi-ts.log

      - name: Verificar snapshot OpenAPI
        run: |
          git diff --exit-code artifacts/openapi.json artifacts/openapi.d.ts || (echo "Artefatos OpenAPI desatualizados. Rode npm run generate:openapi:ts e faça commit." && exit 1)

      - name: Upload artefatos da unidade
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-artifacts
          path: artifacts/unit
          retention-days: 7

      - name: Upload cobertura JS
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: js-coverage
          path: artifacts/js-coverage
          retention-days: 7

  contracts_api:
    name: Testes de contrato (OpenAPI + Jest + Playwright smoke)
    runs-on: ubuntu-latest
    needs: unit_tests
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências do Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Contrato pytest (OpenAPI + casos negativos)
        run: |
          mkdir -p artifacts/contracts
          pytest tests/integration/test_openapi_contract.py tests/integration/test_http_contract_negative.py \
            --junitxml=artifacts/contracts/pytest-contracts.xml | tee artifacts/contracts/output.log

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Instalar dependências JS
        run: npm ci

      - name: Gerar artefatos OpenAPI
        run: npm run generate:openapi:ts | tee artifacts/contracts/openapi-gen.log

      - name: Cliente OpenAPI de verificação de tipo
        run: npm run typecheck:contracts | tee -a artifacts/contracts/openapi-gen.log

      - name: Jest - especificação de contrato
        run: |
          npx cross-env NODE_OPTIONS=--experimental-vm-modules npx jest tests/frontend/contracts.test.js --runInBand \
            | tee artifacts/contracts/jest-contracts.log

      - name: Playwright - fluxos de contrato
        run: |
          npx playwright install --with-deps
          npx playwright test tests/e2e/full_flow.spec.cjs tests/e2e/upload_flow.spec.cjs --reporter=junit \
            | tee artifacts/contracts/playwright-contracts.log

      - name: Upload artefatos de contrato
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: contract-artifacts
          path: artifacts/contracts
          retention-days: 7

  integration_tests:
    name: Testes de integração (pytest)
    runs-on: ubuntu-latest
    needs: contracts_api
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências do Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Executar pytest de integração
        run: |
          mkdir -p artifacts/integration/htmlcov
          pytest tests/integration \
            --cov=src \
            --cov-report=xml:artifacts/integration/coverage.xml \
            --cov-report=html:artifacts/integration/htmlcov \
            --cov-report=term-missing \
            --junitxml=artifacts/integration/pytest-integration.xml | tee artifacts/integration/output.log

      - name: Upload artefatos de integração
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-artifacts
          path: artifacts/integration
          retention-days: 7

  e2e_tests:
    name: Testes E2E (Playwright)
    runs-on: ubuntu-latest
    needs: integration_tests
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências do Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Instalar dependências JS
        run: npm ci

      - name: Instalar navegadores Playwright
        run: npx playwright install --with-deps

      - name: Executar Playwright E2E
        run: |
          mkdir -p artifacts/e2e
          npx playwright test --trace on --reporter=junit | tee artifacts/e2e/output.log

      - name: Upload artefatos E2E (rastreamento + logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            artifacts/e2e
            playwright-report
            test-results
          retention-days: 7

  load_tests:
    name: Testes de carga/desempenho
    runs-on: ubuntu-latest
    needs: e2e_tests
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências do Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Executar conjunto de testes de carga/desempenho
        run: |
          mkdir -p artifacts/load/htmlcov
          pytest tests/performance \
            --cov=src \
            --cov-report=xml:artifacts/load/coverage.xml \
            --cov-report=html:artifacts/load/htmlcov \
            --cov-report=term-missing \
            --junitxml=artifacts/load/pytest-load.xml | tee artifacts/load/output.log

      - name: Upload artefatos de carga
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-artifacts
          path: artifacts/load
          retention-days: 7

  smoke_stub:
    name: Tubo de exaustão de fumaça
    runs-on: ubuntu-latest
    needs: load_tests
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Tubo de exaustão de fumaça
        env:
          TEST_MODE: "1"
          OMNI_TEST_MODE: "1"
          SKIP_RUNTIME_CREDENTIALS_VERIFY: "1"
        run: |
          python scripts/smoke_pipeline_stub.py | tee artifacts/smoke_stub.log

      - name: Upload registro de fumaça
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          path: artifacts/smoke_stub.log
          retention-days: 7

  smoke_real:
    name: Smoke HTTP (servidor stub)
    runs-on: ubuntu-latest
    needs: smoke_stub
    if: ${{ env.RUN_SMOKE_REAL == '1' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Iniciar servidor stub
        env:
          TEST_MODE: "1"
          OMNI_TEST_MODE: "1"
          SKIP_RUNTIME_CREDENTIALS_VERIFY: "1"
          WEBHOOK_SECRET: "stub-secret"
        run: |
          python scripts/stub_server.py > artifacts/smoke_real.log 2>&1 &
          echo $! > stub_server.pid
          sleep 5

      - name: Executar verificações HTTP de fumaça
        run: |
          curl -f http://127.0.0.1:8001/health
          curl -f http://127.0.0.1:8001/api/dashboard/summary
          curl -f http://127.0.0.1:8001/api/dashboard/incidents

      - name: Parar servidor stub
        if: always()
        run: |
          if [ -f stub_server.pid ]; then kill "$(cat stub_server.pid)" || true; fi

      - name: Upload registro real de fumaça
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-real-artifacts
          path: artifacts/smoke_real.log
          retention-days: 7

  build_executable:
    name: Criar executável (PyInstaller)
    runs-on: windows-latest
    needs: smoke_stub
    env:
      SIGNING_CERT_BASE64: ${{ secrets.SIGNING_CERT_BASE64 || '' }}
      SIGNING_CERT_PASSWORD: ${{ secrets.SENHA_DO_CERTIFICADO_DE_ASSINATURA || '' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Calcular tag de versão
        shell: pwsh
        run: |
          $version = "${{ env.VERSION }}"
          if ("${{ github.ref }}" -match "refs/tags/(.+)") { $version = $Matches[1] }
          if (-not $version) { $version = "ci-${{ github.run_number }}" }
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Instalar dependências de build
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Criar arquivo executável único (launcher_gui)
        run: |
          pyinstaller launcher_gui.py --name TranscribeFlow --onefile --noconfirm --paths src

      - name: Assinar executável (opcional)
        if: ${{ env.SIGNING_CERT_BASE64 != '' && env.SIGNING_CERT_PASSWORD != '' }}
        shell: pwsh
        run: |
          $pfxPath = "signing_cert.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String("${{ env.SIGNING_CERT_BASE64 }}"))
          & signtool sign /f $pfxPath /p "${{ env.SIGNING_CERT_PASSWORD }}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 dist/TranscribeFlow.exe

      - name: Cópia versionada do executável
        shell: pwsh
        run: |
          $dest = "dist/TranscribeFlow-${{ env.VERSION }}.exe"
          Copy-Item "dist/TranscribeFlow.exe" $dest -Force

      - name: Certificado de assinatura de limpeza
        if: ${{ env.SIGNING_CERT_BASE64 != '' && env.SIGNING_CERT_PASSWORD != '' }}
        shell: pwsh
        run: Remove-Item signing_cert.pfx -Force -ErrorAction SilentlyContinue

      - name: Verificar assinatura (opcional)
        if: ${{ env.SIGNING_CERT_BASE64 != '' && env.SIGNING_CERT_PASSWORD != '' }}
        shell: pwsh
        run: |
          & signtool verify /pa /all dist/TranscribeFlow.exe
          & signtool verify /pa /all "dist/TranscribeFlow-${{ env.VERSION }}.exe"

      - name: Upload artefato executável
        uses: actions/upload-artifact@v4
        with:
          name: transcribeflow-exe
          path: |
            dist/TranscribeFlow.exe
            dist/TranscribeFlow-${{ env.VERSION }}.exe
          retention-days: 7

  build_installer:
    name: Pacote de instalação de compilação
    runs-on: windows-latest
    needs: build_executable
    steps:
      - uses: actions/checkout@v4

      - name: Baixar executável
        uses: actions/download-artifact@v4
        with:
          name: transcribeflow-exe
          path: dist

      - name: Preparar carga útil do instalador (executável de estágios)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path artifacts/installers -Force | Out-Null
          pwsh ./scripts/prepare_installer.ps1 -SourceExe dist/TranscribeFlow.exe -Destination artifacts/installers
          Copy-Item "dist/TranscribeFlow-${{ env.VERSION }}.exe" "artifacts/installers/TranscribeFlow-${{ env.VERSION }}.exe" -Force

      - name: Upload artefato de instalação
        uses: actions/upload-artifact@v4
        with:
          name: prepared-installer
          path: artifacts/installers

  test_installer:
    name: Teste de fumaça do instalador
    runs-on: windows-latest
    needs: build_installer
    env:
      OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
      CREDENTIALS_SECRET_KEY: ${{ env.CREDENTIALS_SECRET_KEY }}
      RUNTIME_CREDENTIALS_KEY: ${{ env.RUNTIME_CREDENTIALS_KEY }}
      REQUIRE_SIGNATURE: ${{ secrets.SIGNING_CERT_BASE64 != '' && secrets.SENHA_DO_CERTIFICADO_DE_ASSINATURA != '' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: prepared-installer
          path: artifacts/installers

      - name: Estagiar instalador para teste
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "$env:USERPROFILE\Downloads\transcribeflow-installer" -Force | Out-Null
          Copy-Item -Path artifacts/installers/TranscribeFlow.exe -Destination "$env:USERPROFILE\Downloads\transcribeflow-installer" -Force -ErrorAction SilentlyContinue
          if (Test-Path "artifacts/installers/TranscribeFlow-${{ env.VERSION }}.exe") {
            Copy-Item -Path "artifacts/installers/TranscribeFlow-${{ env.VERSION }}.exe" -Destination "$env:USERPROFILE\Downloads\transcribeflow-installer" -Force
          }

      - name: Escrever arquivo env do instalador para teste básico
        shell: pwsh
        run: |
          @"
OPENAI_API_KEY=${{ env.OPENAI_API_KEY }}
CREDENTIALS_SECRET_KEY=${{ env.CREDENTIALS_SECRET_KEY }}
RUNTIME_CREDENTIALS_KEY=${{ env.RUNTIME_CREDENTIALS_KEY }}
"@ | Set-Content -Path scripts/install.env -Encoding UTF8

      - name: Executar teste de fumaça do instalador
        shell: pwsh
        run: |
          pwsh ./scripts/test_installer_flow.ps1 -EnvFile scripts/install.env -StartupTimeout 90

      - name: Arquivo de ambiente do instalador de limpeza
        shell: pwsh
        run: Remove-Item scripts/install.env -Force -ErrorAction SilentlyContinue

      - name: Upload logs de teste do instalador
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: installer-test-artifacts
          path: |
            scripts/installer_test.log
          retention-days: 7

  publish_artifacts:
    name: Publicar artefatos agregados
    runs-on: ubuntu-latest
    needs: test_installer
    steps:
      - name: Baixar todos os artefatos do estágio
        uses: actions/download-artifact@v4
        with:
          path: artifacts/collected

      - name: Listar artefatos coletados
        run: ls -R artifacts/collected

      - name: Reenvio do pacote consolidado
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: artifacts/collected

  release_gate:
    name: Portal de aprovação de lançamento
    runs-on: ubuntu-latest
    needs: publish_artifacts
    environment: production
    steps:
      - name: Aguardar aprovação manual / finalizar lançamento
        run: |
          echo "Liberação aprovada (configure a proteção do ambiente para aprovação manual, se necessário)."

      - name: Criar versão (rascunho) no GitHub
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: true
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/collected/**/*.*
